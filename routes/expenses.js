const express = require('express');
const router = express.Router();
const Expense = require('../models/Expense.js'); // �?�?�?�?�?�?�? �?�?�?���? �?�?�?���?�?�? �?�?���? ��?�?��?�?�? �?�?�?�?�?�?
const auth = require('../middleware/auth.js'); // 

// --- �?�?�?�?�? �?�?�?�? �?�?�?�?�?�? �?���?�?�? �?�?�?�? (POST Request) ---
// �?�?�?�?�? �?��?�? ���?�? POST �?�?�? �?�?�?�?�?�� /api/expenses/
router.post('/', auth, async (req, res) => {
  try {
    // 1. �?�?�?�?�?�?�? �?�?�?�?�?�?�?�? �?�? �?�?���?�? �?�?�?�?�?�? (�?�?���? �?�?�?�?�?�? �?�? Postman)
    const { description, amount, category } = req.body;

    // 2. �?�?�?�?�? �?���?�?�? �?�?�?�? �?�?�?�?�?�?�?�? �?�?�?�?�?���?
    const newExpense = new Expense({
      description,
      amount,
      category,
      user: req.user.id
    });

    // 3. �?�?�? �?�?�?���?�?�? �?�?�?�?�?�? �?�? �?�?�?�?�? �?�?�?�?�?�?�?�?
    const savedExpense = await newExpense.save();

    // 4. �?�?�?�?�? �?�? �?�?�?�? �?�? �?�?�?�?�?�? �?�?�?���?�?�? �?�?���? �?�? �?�?�?�?
    res.status(201).json(savedExpense);

  } catch (error) {
    // �?�? �?�?�? �?�?�?� ��? �?����? �?�?�? �?�?�?�?�? �?�?�?�?�? �?���
    res.status(400).json({ message: error.message });
  }
});


// --- �?�?�?�?�? �?�?�?�? �?�?�?�? �?�? �?�?�?���?�?�?�? (GET Request) ---
// �?�?�?�?�? �?��?�? ���?�? GET �?�?�? �?�?�?�?�?�� /api/expenses/
router.get('/', auth, async (req, res) => {
  try {
    // 1. �?�?�?� �?�? �?�?�?�?�? �?�?�?�?�?�?�?�? �?�? �?�? �?�?�?���?�?�?�? �?�?�?�?�?�?�?�? �?�?�?�?�?���?
    const expenses = await Expense.find({ user: req.user.id });

    // 2. ��?�?�? �?�?�?�? �?�?�?�?�?�? �?�? �?�?�?�?�? �?�?�?���?�?�?�? �?�?�?�? �?�? �?�?�?��?�? �?�?�?�?�?
    res.status(200).json(expenses);

  } catch (error) {
    // �?�? �?�?�? �?�?�?� �?��� �?�? �?�?�?�?�?�?
    res.status(500).json({ message: error.message });
  }
});


// --- �?�?�?�?�? �?�?�?�? �?�?�?�?�?�? �?���?�?�? �?�?�?�? (PUT Request) ---
// :id �?�? �?�?�?�?�? �?�?�?�?�?�?�?�? �?�?�?�?�?�? �?�?�? �?�?�? id �?�?�?�?�� �?�?�?�?���?�?�?
router.put('/:id', auth, async (req, res) => {
  try {
    const updatedExpense = await Expense.findOneAndUpdate(
      { _id: req.params.id, user: req.user.id }, // �?�?�?� �?�? �?�?�?���?�?�? �?�?���? �?�?�? id
      req.body, // �?�? �?�?�?�?�?��? �?�?�?�?�?�?�?�?�? �?�?�?�?�?�?�? �?�?�?�?�?�?�? �?�? �?�?���?�?
      { new: true, runValidators: true } // �?�?�?�?�?�?�?: new: true �?�?�?�?�?�? �?�?�?�?�?�?�?�? �?�?�? �?�?�?�?�?�?�
    );

    if (!updatedExpense) {
      return res.status(404).json({ message: '�?�? �?�?�? �?�?�?��?�? �?�?�? �?�?�?���?�?�?' });
    }
    res.json(updatedExpense); // ��?�?�? �?�?�?���?�?�? �?�?�?�?�?�?� �?�?�?

  } catch (error) {
    res.status(400).json({ message: error.message });
  }
});

// --- �?�?�?�?�? �?�?�?�? �?�?���? �?���?�?�? �?�?�?�? (DELETE Request) ---
router.delete('/:id', auth, async (req, res) => {
  try {
    const deletedExpense = await Expense.findOneAndDelete({ _id: req.params.id, user: req.user.id });

    if (!deletedExpense) {
      return res.status(404).json({ message: '�?�? �?�?�? �?�?�?��?�? �?�?�? �?�?�?���?�?�?' });
    }
    res.json({ message: '�?�? �?���? �?�?�?���?�?�? �?�?�?�?�?' }); // ��?�?�? �?�?�?�?�? �?�?�?�?

  } catch (error) {
    res.status(500).json({ message: error.message });
  }
});


module.exports = router; // �?���?�?�? �?���? �?�?�?�?�?�? �?�?�?�? �?�?�?�?�?�?�?�? �?�? �?�?�?�?�? �?�?�?�?�?�?�?
